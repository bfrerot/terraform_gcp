########## GCLOUD commands ##########



### special parameters

--async == details all the process



### check default config
==> gcloud config list
[accessibility]
screen_reader = False
[compute]
region = europe-west9
zone = europe-west9-a
[core]
account = gcp.navet@gmail.com
disable_usage_reporting = False
project = carbon-gecko-472110-u1

Your active configuration is: [default]

==> gcloud config configurations list
NAME     IS_ACTIVE  ACCOUNT              PROJECT                 COMPUTE_DEFAULT_ZONE  COMPUTE_DEFAULT_REGION
default  True       gcp.navet@gmail.com  carbon-gecko-472110-u1  europe-west9-a        europe-west9



### list zones available

# global
gcloud compute zones list

# with a filter
gcloud compute instances list --filter="zone:ZONE"




################################  INSTANCES



### create a VM

# simplest
gcloud compute instances create ace-instance-1 --zone=europe-west9-a --machine-type=e2-standard-2
Created [https://www.googleapis.com/compute/v1/projects/carbon-gecko-472110-u1/zones/europe-west9-a/instances/ace-instance-1].
NAME            ZONE            MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP     STATUS
ace-instance-1  europe-west9-a  e2-standard-2               10.200.0.26  34.163.145.103  RUNNING

# --async = direct return
gcloud compute instances create ace-instance-1 --zone=europe-west9-a --machine-type=e2-standard-2 --async


# deeply accurate
gcloud compute instances create movingcastlevm3 --project=carbon-gecko-472110-u1 --zone=europe-west9-b --description=test --machine-type=n2-standard-2 --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default --metadata=enable-osconfig=TRUE --can-ip-forward --maintenance-policy=MIGRATE --provisioning-model=STANDARD --local-ssd-recovery-timeout=1 --service-account=778804135717-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/cloud-platform --min-cpu-platform="Intel Ice Lake" --enable-display-device --tags=https-server --create-disk=auto-delete=yes,boot=yes,device-name=movingcastlevm3,image=projects/debian-cloud/global/images/debian-12-bookworm-v20250910,mode=rw,size=10,type=pd-balanced --create-disk=device-name=disk-ssd-movingcastle3,mode=rw,name=disk-ssd-movingcastle3,size=10,type=pd-ssd --local-ssd=interface=NVME --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --labels=goog-ops-agent-policy=v2-x86-template-1-4-0,goog-ec-src=vm_add-gcloud --reservation-affinity=any --threads-per-core=1

# adding a startup script 
???????

# create a spot VM
gcloud compute instances create my-spot-vm --project=<PROJECT_ID> --zone=europe-west9-b --machine-type=n2-standard-2 --provisioning-model=SPOT --create-disk=auto-delete=yes,boot=yes,image=projects/debian-cloud/global/images/debian-12-bookworm-v20250910,mode=rw,size=10
       


### starting a VM

gcloud compute instances start INSTANCE_1 INSTANCE_X



### stopping a VM

gcloud compute instances stop INSTANCE_1 INSTANCE_X



### deleting a VM

# better to add zone information
gcloud compute instances delete movingcastlevm1 --zone=europe-west9-b

# if we went to keep disks
gcloud compute instances delete movingcastlevm1 --zone=europe-west9-b --project=carbon-gecko-472110-u1 --keep-disks=all --quiet

# keeping disk, here bot disk
gcloud compute instances delete ch06-instance-1 ––keep-disks=boot



### inventoring VMs

# all project instances
gcloud compute instances list

# all project instances in a particular zone
gcloud compute instances list --filter="zone=europe-west9-b"

# all but in json format
gcloud compute instances list --format=json

# describe an instance with all fields
gcloud compute instances describe INSTANCE_NAME



### create a instance template

gcloud beta compute instance-groups managed create movingcastle-ig-1 \
    --project=carbon-gecko-472110-u1 \
    --base-instance-name=movingcastle-ig-1 \
    --template=projects/carbon-gecko-472110-u1/regions/europe-west9/instanceTemplates/movingcastle-it-n2d-standard-2-03 \
    --size=1 \
    --zone=europe-west9-a \
    --default-action-on-vm-failure=repair \
    --action-on-vm-failed-health-check=default-action \
    --no-force-update-on-repair \
    --standby-policy-mode=manual \
    --list-managed-instances-results=pageless \
&& \
gcloud beta compute instance-groups managed set-autoscaling movingcastle-ig-1 \
    --project=carbon-gecko-472110-u1 \
    --zone=europe-west9-a \
    --mode=on \
    --min-num-replicas=1 \
    --max-num-replicas=10 \
    --target-cpu-utilization=0.6 \
    --cpu-utilization-predictive-method=none \
    --cool-down-period=60



### delete an instance template

gcloud compute instance-templates delete movingcastle-it-n2-standard-2-02



###create an instance group

gcloud beta compute instance-groups managed create instance-group-1 \
    --project=carbon-gecko-472110-u1 \
    --base-instance-name=instance-group-1 \
    --description=test \
    --template=projects/carbon-gecko-472110-u1/global/instanceTemplates/movingcastle-it-n2-standard-2-02 \
    --size=1 \
    --zones=europe-west9-a,europe-west9-b,europe-west9-c \
    --target-distribution-shape=EVEN \
    --instance-redistribution-type=proactive \
    --default-action-on-vm-failure=repair \
    --action-on-vm-failed-health-check=default-action \
    --no-force-update-on-repair \
    --standby-policy-mode=manual \
    --list-managed-instances-results=pageless \
&& \
gcloud beta compute instance-groups managed set-autoscaling instance-group-1 \
    --project=carbon-gecko-472110-u1 \
    --region=europe-west9 \
    --mode=on \
    --min-num-replicas=1 \
    --max-num-replicas=10 \
    --target-cpu-utilization=0.6 \
    --cpu-utilization-predictive-method=none \
    --cool-down-period=60



### delete an instance group

# if distributed over multi-zones, we have to specify the region
gcloud compute instance-groups managed delete movingcastle-ig-2 --region="europe-west9"



### create a VM Snapshot

# basic
gcloud compute disks snapshot DISK_NAME --snapshot-names=NAME

# with more information
gcloud compute snapshots create snapshot-2  --project=carbon-gecko-472110-u1 --description=test --labels=navet=vm1 --source-disk=movingcastlevm1 --source-disk-zone=europe-west9-b --guest-flush --storage-location=europe-west9



### list snapshots

gcloud compute snapshots list



### create a vm image

gcloud compute images create imagevm1 --project=carbon-gecko-472110-u1 --description=test --source-disk=movingcastlevm1 --source-disk-zone=europe-west9-b --labels=navet=vm1 --storage-location=europe-west9



### delete an image

gcloud compute images delete IMAGE_NAME



### list images

gcloud compute images list



### export an image to Cloud storage

gcloud compute images export --destination-uri=DESTINATION_URI ––image=IMAGE_NAME



### create instance template

gcloud beta compute instance-templates create movingcastle-it-2 --project=carbon-gecko-472110-u1 --machine-type=n2-standard-2 --network-interface=network=default,network-tier=PREMIUM,stack-type=IPV4_ONLY --instance-template-region=europe-west9 --can-ip-forward --no-restart-on-failure --maintenance-policy=TERMINATE --provisioning-model=SPOT --instance-termination-action=STOP --discard-local-ssds-at-termination-timestamp=true --service-account=778804135717-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/cloud-platform --enable-display-device --tags=https-server,lb-health-check --create-disk=auto-delete=yes,boot=yes,device-name=movingcastle-it-2,image=projects/debian-cloud/global/images/debian-12-bookworm-v20250910,mode=rw,size=10,type=pd-balanced --create-disk=device-name=persistent-disk-1,mode=rw,size=100,type=pd-ssd --local-ssd=interface=NVME --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=none




################################  KUBERNETES


### create a gke autopilot cluster

gcloud beta container --project "carbon-gecko-472110-u1" clusters create-auto "movingcastle-gke-cluster-1" --region "europe-west9" --release-channel "regular" --enable-dns-access --no-enable-google-cloud-access --network "projects/carbon-gecko-472110-u1/global/networks/default" --subnetwork "projects/carbon-gecko-472110-u1/regions/europe-west9/subnetworks/default" --cluster-ipv4-cidr "/17" --binauthz-evaluation-mode=DISABLED --scopes=https://www.googleapis.com/auth/cloud-platform

gcloud container clusters create ch07-cluster-1 --num-nodes=4



### install kubectl gcoud commands

gcloud components install kubectl



### create a cluster with kubectl

kubectl create deployment app-deploy1 --image=app1 --port=8080



### adapt replicas number with kubectl

kubectl scale deployment app-deploy1 --replicas=5

kubectl scale deployment ch07-app-deploy --replicas=10



### viewing the status of Kubernetes Clusters
/!\ the service was originally called Google Container Engine
In November 2017, Google renamed the service Kubernetes Engine, but the gcloud commands remained the same

gcloud container clusters list 

# en detail
gcloud container clusters describe --zone=REGION CLUSTER_NAME



### list information about nodes and pods
/!\ we need to use kubectl

gcloud container clusters get-credentials --zone=REGION CLUSTER_NAME



### modify nodes number

number of nodes we specify in the command will be:
==> the number of nodes in the pool if we are using a zonal cluster
==> the number of nodes for each zone the node pool is in if you are using a regional cluster

gcloud container clusters resize CLUSTER_NAME --node-pool default- pool –num-nodes 5 --region=REGION



### update a cluster

gcloud container clusters update CLUSTER_NAME --enable-autoscaling --min-nodes 1 --max-nodes 5 --zone ZONE --node-pool default-pool



### list deployments

kubectl get deployments



### modify the deployment scale

kubectl scale deployment nginx-1 --replicas 5



### configure autoscale

kubectl autoscale deployment DEPLOYMENT_NAME --max 10 --min 1 --cpu-percent 80



### remove a deployment

kubectl delete deployment DEPLOYMENT_NAME



### add a service

kubectl create deployment DEPLOYMENT_NAME --image=gcr.io/google/samples/hello-app:1.0 --port 8080



### expose a service

kubectl expose deployment DEPLOYMENT_NAME --type="LoadBalancer"



### remove a service

kubectl delete service DEPLOYMENT_NAME




################################  CLOUD RUN


### create a Cloud Run 

gcloud alpha run deploy hello \
--image=us-docker.pkg.dev/cloudrun/container/hello \
--no-invoker-iam-check \
--port=8080 \
--service-account=778804135717-compute@developer.gserviceaccount.com \
--region=europe-west1 \
--project=carbon-gecko-472110-u1




################################# STORAGE 

### create a REDIS instance, standard
gcloud redis instances create --project=carbon-gecko-472110-u1  movingcastle-redis-001 --tier=basic --size=16 --region=europe-west9 --redis-version=redis_7_2 --network=projects/carbon-gecko-472110-u1/global/networks/default --connect-mode=DIRECT_PEERING --display-name="movingcastle-redis-001"






#################################  VPC

### create in an auto-mode, in default project
gcloud compute networks create ace-exam-vpc1 --subnet-mode=auto



### en mode custom
gcloud compute networks create ace-exam-vpc1 --subnet-mode=custom
gcloud compute networks subnets create ace-exam-vpc-subnet1 --network=ace-exam-vpc1 --region=us-west2 --range=10.10.0.0/16 --enable-private-ip-google-access --enable-flow-logs



### create a shared VPC

1- assign the Shared VPC Admin role, which uses the descriptor roles/compute.xpnAdmin, issue this command:
gcloud organizations add-iam-policy-binding [ORG_ID] --member='user:[EMAIL_ADDRESS]' --role="roles/compute.xpnAdmin"
gcloud resource-manager folders add-iam-policy-binding [FOLDER_ID] --member='user:[EMAIL_ADDRESS]' --role="roles/compute.xpnAdmin"

to get ORAGNIZATION ID
gcloud organizations list

to get FOLDER ID 
gcloud resource-manager folders list --organization=[ORG_ID]

2 - enable shred vpc
gcloud compute shared-vpc enable [HOST_PROJECT_ID]

3- associate projects to shared VPC
gcloud compute shared-vpc associated-projects add [SERVICE_PROJECT_ID] --host-project [HOST_PROJECT_ID]



### create a VPC Peering

1- A-side 
gcloud compute networks peerings create peer-ace-exam-1 --network ace-exam-network-A --peer-project ace-exam-project-B --peer-network ace-exam-network-B --auto-create-routes

2- B-side
gcloud compute networks peerings create peer-ace-exam-1 --network ace-exam-network-B --peer-project ace-exam-project-A --peer-network ace-exam-network-A --auto-create-routes



#################################  FW 


### options
--action
--allow
--description
--destination-ranges
--direction
--network = VPC name
--priority
--source-ranges
--source-service-accounts
--source-tags
--target-service-accounts
--target-tags

### create a FW rule
gcloud compute firewall-rules create ace-exam-fwr2 --network ace-exam-vpc1 --allow tcp:20000-25000




#################################  VPN

gcloud compute target-vpn-gateways
gcloud compute forwarding-rule
gcloud compute vpn-tunnels

gcloud compute vpn-tunnels create TUNNEL_NAME --peer-address=PEER_IP_ADDRESS --shared-secret=SHARED_SECRET --target-vpn-gateway=TARGET_VPN_GATEWAY

gcloud compute forwarding-rules create NAME --TARGET_SPECIFICATION=VPN_GATEWAY





#################################  DNS

gcloud dns managed-zones
gcloud dns record-sets transaction

### create a managed public zone called ace-exam-zone1 with the DNS suffix aceexamzone.com
gcloud dns managed-zones create ace-exam-zone1 --description= "A sample zone" --dns-name=aceexamzone.com

### make this a private zone, we add the --visibility parameter set to private:
gcloud dns managed-zones create ace-exam-zone1 --description= "A sample zone" --dns-name=aceexamzone.com. --visibility=private --networks=default

### add an A record, we start a transaction, add the A record information, and then execute the transaction
gcloud dns record-sets transaction start --zone=ace-exam-zone1
gcloud dns record-sets transaction add 192.0.2.91 --name=aceexamzone.com. --ttl=300 --type=A --zone=ace-exam-zone1
gcloud dns record-sets transaction execute --zone=ace-exam-zone1

###  create a CNAME record, same process
gcloud dns record-sets transaction start --zone=ace-exam-zone1
gcloud dns record-sets transaction add server1.aceexamezone.com. --name=www2.aceexamzone.com. --ttl=300 --type=CNAME --zone=ace-exam-zone1
gcloud dns record-sets transaction execute --zone=ace-exam-zone1




#################################  IP ADRESSING

### expand a subnet
gcloud compute networks subnets expand-ip-range ace-exam-subnet1 --prefix-length 16

### reduce a subnet IS NOT POSSIBLE











